<!DOCTYPE html>
<html>
<head>
  <meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no' />
 <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.css" />
 <!--[if lte IE 8]>
     <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.ie.css" />
 <![endif]-->
  <script src="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.js"></script>
 
 <link rel="stylesheet" href="http://cgross.free.fr/map/lib/Leaflet.EditInOSM.css" />
 <script src="http://cgross.free.fr/map/lib/Leaflet.EditInOSM.js"></script>
 
  <script src="http://cgross.free.fr/map/lib/leaflet-hash.js"></script>
 
  <script src="http://tile.openstreetmap.fr/~cquest/leaflet/js/L.Control.MousePosition.js"></script>
  
   
  <script src="http://osmose.openstreetmap.fr/fr/map/leaflet-plugins/layer/tile/Google.js"></script>
  <script src="http://maps.google.com/maps/api/js?v=3&sensor=false"></script>

<link rel="stylesheet" href="http://cgross.free.fr/map/lib/leaflet.photon.css" />
<script src="http://cgross.free.fr/map/lib/leaflet.photon.js"></script>

<link href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">
<link rel="stylesheet" href="http://cgross.free.fr/map/lib/L.Control.Locate.min.css" />
<!--[if lt IE 9]>
    <link rel="stylesheet" href="http://cgross.free.fr/map/lib/L.Control.Locate.ie.min.css"/>
<![endif]-->
<script src="http://cgross.free.fr/map/lib/L.Control.Locate.min.js" ></script>
  
  <script src="http://kartenkarsten.github.io/leaflet-layer-overpass/OverPassLayer.js"></script>
  
  <style>
    body { margin:0; padding:0; }
    #map { position:absolute; top:0; bottom:0; width:100%; }
    

.photon-autocomplete li .type {
    font-family: 'open_sanslight';
    font-weight: normal;
    float: right;
    font-size: 0.8em;
}

    
  </style>
</head>
<body>
<div id='map'></div>
<script type='text/javascript'>

// couche "osmfr"
var osmfr = L.tileLayer('http://{s}.tile.openstreetmap.fr/osmfr/{z}/{x}/{y}.png', {
    attribution: 'donn&eacute;es &copy; <a href="http://osm.org/copyright">OpenStreetMap</a>/ODbL - rendu cquest',
    minZoom: 1,
    maxZoom: 20
});

var hot = L.tileLayer('http://{s}.tile.openstreetmap.fr/hot/{z}/{x}/{y}.png', {
    attribution: 'donn&eacute;es &copy; <a href="http://osm.org/copyright">OpenStreetMap</a>/ODbL - rendu ybon',
    minZoom: 1,
    maxZoom: 20
});

var osm = L.tileLayer('http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: 'Tuiles OSM - donn&eacute;es &copy; <a href="http://osm.org/copyright">OpenStreetMap</a>/ODbL',
    minZoom: 1,
    maxZoom: 20
  });
  
var mapquest =   L.tileLayer('http://otile1.mqcdn.com/tiles/1.0.0/osm/{z}/{x}/{y}.png', {
    attribution: 'Tuiles <a href="http://www.mapquest.com/" target="_blank">&copy; MapQuest</a> <img src="http://developer.mapquest.com/content/osm/mq_logo.png"> - donn&eacute;es &copy; <a href="http://osm.org/copyright">OpenStreetMap</a>/ODbL',
    minZoom: 1,
    maxZoom: 20
  });

var river =   L.tileLayer( 'http://{s}.tile.openstreetmap.fr/openriverboatmap/{z}/{x}/{y}.png', {
    attribution: 'Calque &copy; ybon -  - donn&eacute;es &copy; <a href="http://osm.org/copyright">OpenStreetMap</a>/ODbL',
    minZoom: 1,
    maxZoom: 20
  });

var bw = L.tileLayer('http://www.toolserver.org/tiles/bw-mapnik/{z}/{x}/{y}.png', {
		attribution: 'donn&eacute;es &copy; <a href="http://osm.org/copyright">OpenStreetMap</a>/ODbL',
    minZoom: 1,
    maxZoom: 20
  });

var route500 = L.tileLayer('http://{s}.tile.openstreetmap.fr/route500/{z}/{x}/{y}.png', {
	attribution: 'Route500 &copy; IGN - LO/OL',
    minZoom: 1,
    maxZoom: 20
  });

var carthage = L.tileLayer('http://a.tile.openstreetmap.fr/route500hydro/{z}/{x}/{y}.png', {
		attribution: 'BD Carthage (IGN/ONEMA) - LO/OL',
    minZoom: 1,
    maxZoom: 20
  });


var relief = L.tileLayer('http://tiles2.openpistemap.org/landshaded/{z}/{x}/{y}.png', {
	attribution: 'Relief openpistemap (source NASA SRTMv3 + ASTER)',
    minZoom: 1,
    maxZoom: 16
  });

var fradm = L.tileLayer('http://{s}.tile.openstreetmap.fr/fradm/{z}/{x}/{y}.png', {
    attribution: 'FR-ADM &copy; <a href="http://wiki.openstreetmap.org/wiki/FR:Servers/tile.openstreetmap.fr">OSM-FR/cquest</a>',
    minZoom: 1,
    maxZoom: 20
  });

var qa = L.tileLayer('http://{s}.tile.openstreetmap.fr/qa/{z}/{x}/{y}.png', {
    attribution: 'QA &copy; <a href="http://wiki.openstreetmap.org/wiki/FR:Servers/tile.openstreetmap.fr">OSM-FR/cquest</a> - donn&eacute;es OSM/INSEE/DGFiP',
    minZoom: 1,
    maxZoom: 20
  });

var bano = L.tileLayer('http://{s}.layers.openstreetmap.fr/bano/{z}/{x}/{y}.png', {
    attribution: '<a href="https://wiki.openstreetmap.org/wiki/WikiProject_France/WikiProject_Base_Adresses_Nationale_Ouverte_(BANO)">BANO</a> - Calque &copy; <a href="http://wiki.openstreetmap.org/wiki/User:Cquest">cquest</a>',
    minZoom: 1,
    maxZoom: 20
  });

var wms = L.tileLayer('http://wms.openstreetmap.fr/tms/1.0.0/tous_fr/{z}/{x}/{y}', {
    attribution: 'images a&eacute;riennes en opendata (sources diverses)',
    minZoom: 1,
    maxZoom: 20
  });

var cadastre = L.tileLayer('http://tms.cadastre.openstreetmap.fr/*/tout/{z}/{x}/{y}.png', {
    attribution: 'cadastre',
    minZoom: 1,
    maxZoom: 20
  });

var cadastreT = L.tileLayer('http://tms.cadastre.openstreetmap.fr/*/transp/{z}/{x}/{y}.png', {
    attribution: 'cadastre transparent',
    minZoom: 1,
    maxZoom: 20
  });

//OverPassAPI overlay
var opl = new L.OverPassLayer({
  minzoom: 10,
  query: "node(BBOX)['historic'='memorial'];out;",	
  callback: function(data) {
    for(var i=0;i<data.elements.length;i++) {
      var e = data.elements[i];

      if (e.id in this.instance._ids) return;
      this.instance._ids[e.id] = true;
      var pos = new L.LatLng(e.lat, e.lon);
      var popup = this.instance._poiInfo(e.tags,e.id);
      var color = e.tags["ref:FR:MemorialGenWeb"] ? 'green':'red';
      
	  var link = document.createElement("a");
		link.target="_blank";
		link.href = "http://rawedit.openstreetmap.fr/edit/node/" + e.id;
		link.appendChild(document.createTextNode("RawEdit"));
	  popup.appendChild(link);
	  
	  var link2 = document.createElement("a");
		link2.target="_blank";
		link2.href = "http://www.memorial-genweb.org/~memorial2/html/fr/resultcommune.php?idsource=" + e.tags["ref:FR:MemorialGenWeb"];
		link2.appendChild(document.createTextNode("|MemorialGenWeb"));
	  popup.appendChild(link2);
	  
	  
	  var circle = L.circle(pos, 50, {
        color: color,
        fillColor: '#fa3',
        fillOpacity: 0.5
      })
      .bindPopup(popup);
      this.instance.addLayer(circle);
    }
  },
});

  
  
var ggl = new L.Google();

//var ggl2 = new L.Google('TERRAIN');  
  

// liste des couches de base
var baseMaps = {
    "Rendu FR": osmfr,
    "Rendu HOT-HDM": hot,
    "OSM/Mapnik - international": osm,
    "MapQuest": mapquest,
    "OpenRiverBoat": river,
    "OSM monochrome": bw,
	"Cadastre": cadastre,
	"GMap": ggl
	//"GMap2": ggl2
};

var overlays = {
	"Route500 IGN": route500,
	"BD Carthage": carthage,
	"Ombrage": relief,
	"Limites admin. FR": fradm,
	"'QA' - Zone &agrave; compl&eacute;ter": qa,
	"'BANO' - Couverture": bano,
	"Images a&eacute;riennes opendata": wms,
	"Cadastre Transparent": cadastreT,
	"Monuments aux morts":opl
};



var searchPoints = L.geoJson(null, {
        onEachFeature: function (feature, layer) {
            layer.bindPopup(feature.properties.name);
        }
    });

function showSearchPoints(geojson) {
    console.debug('begin handler');
    searchPoints.clearLayers();
    searchPoints.addData(geojson);
    console.debug('end handler');
};

function myHandler(geojson) {
    console.debug(geojson);
};

var formatResult = function (feature, el) {
    var title = L.DomUtil.create('strong', '', el),
        detailsContainer = L.DomUtil.create('small', '', el),
        details = [];
    title.innerHTML = feature.properties.label || feature.properties.name;
    var types = {
        housenumber: 'numéro',
        street: 'rue',
        locality: 'lieu-dit',
        hamlet: 'hameau',
        village: 'village',
        city: 'ville',
        commune: 'commune'
    };
    if (types[feature.properties.type]) L.DomUtil.create('span', 'type', title).innerHTML = types[feature.properties.type];
    if (feature.properties.city && feature.properties.city !== feature.properties.name) {
        details.push(feature.properties.city);
    }
    if (feature.properties.context) details.push(feature.properties.context);
    detailsContainer.innerHTML = details.join(', ');
};


var SHORT_CITY_NAMES = ['y', 'ay', 'bu', 'by', 'eu', 'fa', 'gy', 'oo', 'oz', 'py', 'ri', 'ry', 'sy', 'ur', 'us', 'uz'];
var photonControlOptions = {
    resultsHandler: showSearchPoints,
    placeholder: 'Ex. 6 quai de la tourelle cergy…',
    position: 'topleft',
    url: 'http://api-adresse.data.gouv.fr/search/?',
    formatResult: formatResult,
    noResultLabel: 'Aucun résultat',
    minChar: function (val) {
        return SHORT_CITY_NAMES.indexOf(val) !== -1 || val.length >= 3;
    },
    submitDelay: 200
};


// création de la carte, centrée sur la France
map = L.map('map', { center: [47.000,2.000], zoom: 10, layers: [osmfr], editInOSMControlOptions: { position: 'bottomright' }, photonControl: true, photonControlOptions: photonControlOptions } );

searchPoints.addTo(map);

// ajout de l'échelle
L.control.scale().addTo(map);

// ajout de la géolocalisation
L.control.locate({ follow: false }).addTo(map);

map.locate({setView: true, watch: true});


// ajout du sélecteur de couches
L.control.layers(baseMaps, overlays).addTo(map);
// ajout de la position du curseur
L.control.mousePosition( { position: 'bottomright' } ).addTo(map);

// ajout de la gestion des URL 
var hash = new L.Hash(map);



</script>
</body>
</html>
